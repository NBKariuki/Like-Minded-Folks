/**
 * MMF DEPOSIT LOGGER — Apps Script Web App
 * ═══════════════════════════════════════════════════════════════
 *
 * SHEET STRUCTURE (Master Record)
 * ────────────────────────────────
 *  Row 4  → Week numbers        (1, 2, 3 … in cols G+)
 *  Row 5  → Month names         (JANUARY, FEBRUARY … merged)
 *  Row 6  → Date range headers  (text: "05/01/26\n11/01/26" in cols G+)
 *  Col A  → Row number
 *  Col B  → Member name
 *  Col C  → Partner alias
 *  Col D  → Phone number
 *  Col E  → Alias  ← used for lookup
 *  Col F  → Total Amount (formula — NEVER touched)
 *  Col G+ → Weekly deposit cells, rows 7–30
 *
 * SECURITY
 * ────────
 *  • HTML ADMIN_PIN  → gates the UI only
 *  • SERVER_PIN here → checked server-side before anything is written
 *  • Rate limiting   → 3 wrong PINs → 30-min lockout per device token
 *  • Audit log       → every event recorded regardless of outcome
 *
 * SETUP
 * ─────
 *  1. Paste into Apps Script (Extensions → Apps Script)
 *  2. Set SERVER_PIN below — must match SERVER_PIN in admin-deposit.html
 *  3. Run testFullPipeline() to verify everything works
 *  4. Deploy → New Deployment → Web App
 *     Execute as: Me | Who has access: Anyone
 *  5. Copy /exec URL → paste into admin-deposit.html as APPS_SCRIPT_URL
 */


// ══════════════════════════════════════════════════════════════════
// CONFIGURATION
// ══════════════════════════════════════════════════════════════════

var SERVER_PIN   = '4040';
var WORKBOOK_ID  = '1tdeAHRTMs7Hnam1zcbs6IfiVGX3BVXAW02BswQ-P36s';

var DEPOSIT_LOG_SHEET = 'Deposit Log';
var AUDIT_LOG_SHEET   = 'Audit Log';
var MASTER_SHEET      = 'Master Record';

// Master Record layout
var ALIAS_COL      = 5;   // Col E — member aliases
var TOTAL_COL      = 6;   // Col F — Total Amount (formula, never write here)
var FIRST_WEEK_COL = 7;   // Col G — first weekly deposit column
var FIRST_DATA_ROW = 7;   // First member data row
var LAST_DATA_ROW  = 30;  // Last member data row

// Header rows
var WEEK_NUM_ROW   = 4;   // Row 4 — week numbers
var MONTH_ROW      = 5;   // Row 5 — month names
var DATE_HDR_ROW   = 6;   // Row 6 — date range text headers

// Rate limiting
var MAX_ATTEMPTS   = 3;
var LOCKOUT_MINS   = 30;


// ══════════════════════════════════════════════════════════════════
// ENTRY POINTS
// ══════════════════════════════════════════════════════════════════

function doPost(e) {
  var data;
  try {
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    return respond({ status: 'error', message: 'Invalid JSON: ' + err.toString() });
  }

  var clientToken = data.clientToken || 'unknown';
  var device      = data.device      || 'unknown';

  // 1. Rate limit check
  if (isLocked(clientToken)) {
    auditLog('BLOCKED', clientToken, device, false,
             aliasesFromData(data), data.totalAmount, data.refCode,
             'Locked out — too many wrong PINs');
    return respond({ status: 'blocked', message: 'Too many failed attempts. Try again in 30 minutes.' });
  }

  // 2. PIN check
  if (!data.pin || data.pin !== SERVER_PIN) {
    var remaining = recordFailure(clientToken);
    if (remaining <= 0) {
      auditLog('BLOCKED', clientToken, device, false,
               aliasesFromData(data), data.totalAmount, data.refCode,
               'Locked after ' + MAX_ATTEMPTS + ' wrong PINs');
    } else {
      auditLog('WRONG_PIN', clientToken, device, false,
               aliasesFromData(data), data.totalAmount, data.refCode,
               remaining + ' attempt(s) remaining');
    }
    return respond({ status: 'wrong_pin', message: 'Incorrect PIN.' });
  }

  // 3. Correct PIN — clear failures, write data
  clearFailures(clientToken);

  try {
    writeDepositLog(data);
    var masterResult = postToMaster(data);
    auditLog('DEPOSIT', clientToken, device, true,
             aliasesFromData(data), data.totalAmount, data.refCode,
             masterResult);
    return respond({ status: 'ok', rows: data.credits ? data.credits.length : 1, detail: masterResult });
  } catch (err) {
    auditLog('ERROR', clientToken, device, true,
             aliasesFromData(data), data.totalAmount, data.refCode, err.toString());
    return respond({ status: 'error', message: err.toString() });
  }
}

function doGet() {
  return respond({ status: 'ok', service: 'MMF Deposit Logger', time: eatNow() });
}


// ══════════════════════════════════════════════════════════════════
// MASTER RECORD
// ══════════════════════════════════════════════════════════════════

/**
 * For each credit line:
 *   1. Find member row by alias (col E, rows 7–30)
 *   2. Find week column by matching deposit date to row-6 header
 *   3. Add credit amount to existing cell value
 *   4. Append audit note to cell [REFCODE · KES amount · DD/MM/YY]
 *
 * Date matching strategy:
 *   Row 6 headers are text like "05/01/26\n11/01/26" (start\nend of week).
 *   We extract the START date of each header, find the Monday of the
 *   deposit date, and match them. Both are normalised to YYYY-MM-DD keys.
 */
function postToMaster(data) {
  var ss    = SpreadsheetApp.openById(WORKBOOK_ID);
  var sheet = ss.getSheetByName(MASTER_SHEET);
  if (!sheet) return 'SKIP: Master Record sheet not found';

  // ── Build alias → row map ─────────────────────────────────────
  var aliasValues = sheet
    .getRange(FIRST_DATA_ROW, ALIAS_COL, LAST_DATA_ROW - FIRST_DATA_ROW + 1, 1)
    .getValues();

  var aliasMap = {};
  aliasValues.forEach(function (row, i) {
    var alias = trim(row[0]);
    if (alias) aliasMap[alias.toLowerCase()] = FIRST_DATA_ROW + i;
  });

  Logger.log('Alias map: ' + JSON.stringify(aliasMap));

  // ── Build week-start-key → column map ────────────────────────
  var lastCol   = sheet.getLastColumn();
  var weekCols  = lastCol - FIRST_WEEK_COL + 1;
  if (weekCols < 1) return 'SKIP: No week columns found';

  var headerRow = sheet
    .getRange(DATE_HDR_ROW, FIRST_WEEK_COL, 1, weekCols)
    .getValues()[0];

  var weekMap = {};
  headerRow.forEach(function (cell, i) {
    var raw = trim(cell.toString());
    if (!raw) return;

    // Extract first date from the cell text.
    // Handles: "05/01/26\n11/01/26", "05/01/26 11/01/26", "05/01/26"
    // Also handles full year: "05/01/2026"
    var firstPart = raw.split(/[\n\r\s]+/)[0];
    var parsed    = parseDMY(firstPart);
    if (!parsed) {
      Logger.log('Could not parse header cell col ' + (FIRST_WEEK_COL + i) + ': "' + raw + '"');
      return;
    }
    var key = toKey(parsed);
    weekMap[key] = FIRST_WEEK_COL + i;
    Logger.log('Week col ' + (FIRST_WEEK_COL + i) + ' → key ' + key + ' (raw: "' + raw + '")');
  });

  Logger.log('Week map keys: ' + JSON.stringify(Object.keys(weekMap)));

  // ── Find the week column for this deposit ─────────────────────
  var depositDate    = parseDateSafe(data.date);
  var weekStart      = getWeekStart(depositDate);  // Monday of deposit week
  var depositWeekKey = toKey(weekStart);

  Logger.log('Deposit date: ' + data.date + ' → week start key: ' + depositWeekKey);

  var weekCol = weekMap[depositWeekKey];
  if (!weekCol) {
    var msg = 'SKIP: No column found for week ' + depositWeekKey +
              '. Available: ' + Object.keys(weekMap).join(', ');
    Logger.log(msg);
    return msg;
  }

  // ── Write each credit ─────────────────────────────────────────
  var d        = depositDate;
  var noteDate = pad(d.getDate()) + '/' + pad(d.getMonth() + 1) + '/' +
                 String(d.getFullYear()).slice(2);

  var written = [];
  data.credits.forEach(function (credit) {
    var memberRow = aliasMap[trim(credit.alias).toLowerCase()];
    if (!memberRow) {
      Logger.log('Alias not found: "' + credit.alias + '"');
      return;
    }

    // Guard: never write to Total column
    if (weekCol === TOTAL_COL) {
      Logger.log('Refusing to write to Total column for ' + credit.alias);
      return;
    }

    var cell     = sheet.getRange(memberRow, weekCol);
    var existing = toNumber(cell.getValue());
    cell.setValue(existing + credit.amount);
    cell.setNumberFormat('#,##0.00');

    // Append note if ref not already recorded
    var noteText  = '[' + data.refCode + ' · KES ' + fmtNum(credit.amount) + ' · ' + noteDate + ']';
    var existNote = cell.getNote() || '';
    if (existNote.indexOf(data.refCode) === -1) {
      cell.setNote(existNote ? existNote + '\n' + noteText : noteText);
    }

    Logger.log('Written: ' + credit.alias + ' row=' + memberRow + ' col=' + weekCol +
               ' existing=' + existing + ' +' + credit.amount);
    written.push(credit.alias + ' +' + credit.amount);
  });

  return written.length
    ? 'OK: ' + written.join(', ') + ' → col ' + weekCol
    : 'SKIP: No aliases matched';
}


// ══════════════════════════════════════════════════════════════════
// DEPOSIT LOG
// ══════════════════════════════════════════════════════════════════

var DEPOSIT_HEADERS = [
  'Logged At (EAT)', 'Deposit Date', 'Week',
  'Received From', 'Method', 'Total Amount (KES)',
  'Reference Code', 'Credit To', 'Credit Amount (KES)',
  'Type', 'Notes'
];

function writeDepositLog(data) {
  var ss    = SpreadsheetApp.openById(WORKBOOK_ID);
  var sheet = ss.getSheetByName(DEPOSIT_LOG_SHEET);

  if (!sheet) {
    sheet = ss.insertSheet(DEPOSIT_LOG_SHEET);
    var hdr = sheet.getRange(1, 1, 1, DEPOSIT_HEADERS.length);
    hdr.setValues([DEPOSIT_HEADERS]);
    hdr.setBackground('#00423e');
    hdr.setFontColor('#ffffff');
    hdr.setFontWeight('bold');
    hdr.setFontSize(11);
    sheet.setFrozenRows(1);
    [155, 100, 45, 110, 75, 130, 120, 110, 130, 65, 200].forEach(function (w, i) {
      sheet.setColumnWidth(i + 1, w);
    });
  }

  var now  = eatNow();
  var type = data.isSplit ? 'SPLIT' : 'SINGLE';

  data.credits.forEach(function (credit, i) {
    var row = [
      i === 0 ? now                       : '',
      data.date                           || '',
      data.week                           || '',
      data.from                           || '',
      data.method                         || '',
      i === 0 ? (data.totalAmount || 0)   : '',
      i === 0 ? (data.refCode     || '')  : '',
      credit.alias                        || '',
      credit.amount                       || 0,
      type,
      i === 0 ? (data.notes       || '')  : ''
    ];
    sheet.appendRow(row);

    var lr = sheet.getLastRow();
    sheet.getRange(lr, 6).setNumberFormat('#,##0.00');
    sheet.getRange(lr, 9).setNumberFormat('#,##0.00');
    if (lr % 2 === 0) {
      sheet.getRange(lr, 1, 1, DEPOSIT_HEADERS.length).setBackground('#f4f7fb');
    }
  });
}


// ══════════════════════════════════════════════════════════════════
// AUDIT LOG
// ══════════════════════════════════════════════════════════════════

function auditLog(event, token, device, pinOk, aliases, amount, refCode, outcome) {
  try {
    var ss    = SpreadsheetApp.openById(WORKBOOK_ID);
    var sheet = ss.getSheetByName(AUDIT_LOG_SHEET);

    if (!sheet) {
      sheet = ss.insertSheet(AUDIT_LOG_SHEET);
      var hdrs = ['Timestamp (EAT)', 'Event', 'Client Token', 'Device',
                  'PIN OK?', 'Alias(es)', 'Amount (KES)', 'Ref Code', 'Outcome'];
      var hdr  = sheet.getRange(1, 1, 1, hdrs.length);
      hdr.setValues([hdrs]);
      hdr.setBackground('#1a0a2e');
      hdr.setFontColor('#ffffff');
      hdr.setFontWeight('bold');
      sheet.setFrozenRows(1);
    }

    sheet.appendRow([
      eatNow(),
      event,
      token,
      (device || '').toString().slice(0, 80),
      pinOk ? 'YES' : 'NO',
      aliases  || '',
      amount   || '',
      refCode  || '',
      outcome  || ''
    ]);
  } catch (err) {
    Logger.log('Audit log write failed: ' + err);
  }
}


// ══════════════════════════════════════════════════════════════════
// RATE LIMITING
// ══════════════════════════════════════════════════════════════════

function isLocked(token) {
  var props      = PropertiesService.getScriptProperties();
  var lockedUtil = props.getProperty('locked_' + token);
  if (!lockedUtil) return false;
  if (new Date().getTime() < parseInt(lockedUtil)) return true;
  // Expired — clean up
  props.deleteProperty('locked_' + token);
  props.deleteProperty('fails_'  + token);
  return false;
}

/** Records a failure. Returns remaining attempts (0 = just locked). */
function recordFailure(token) {
  var props = PropertiesService.getScriptProperties();
  var count = parseInt(props.getProperty('fails_' + token) || '0') + 1;
  props.setProperty('fails_' + token, count.toString());
  var remaining = MAX_ATTEMPTS - count;
  if (remaining <= 0) {
    var until = new Date().getTime() + LOCKOUT_MINS * 60 * 1000;
    props.setProperty('locked_' + token, until.toString());
  }
  return Math.max(remaining, 0);
}

function clearFailures(token) {
  var props = PropertiesService.getScriptProperties();
  props.deleteProperty('fails_'  + token);
  props.deleteProperty('locked_' + token);
}


// ══════════════════════════════════════════════════════════════════
// DATE HELPERS
// ══════════════════════════════════════════════════════════════════

/**
 * Parses DD/MM/YY or DD/MM/YYYY text → Date (local, no timezone shift).
 * Returns null if unparseable.
 */
function parseDMY(str) {
  if (!str) return null;
  str = trim(str);
  var m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (!m) return null;
  var day = parseInt(m[1]);
  var mon = parseInt(m[2]) - 1;  // 0-indexed
  var yr  = parseInt(m[3]);
  if (yr < 100) yr += 2000;
  return new Date(yr, mon, day);
}

/**
 * Parses a deposit date string safely.
 * Accepts YYYY-MM-DD (from the HTML form) without UTC timezone shift.
 */
function parseDateSafe(str) {
  if (!str) return new Date();
  str = trim(str);
  // YYYY-MM-DD
  var iso = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (iso) return new Date(parseInt(iso[1]), parseInt(iso[2]) - 1, parseInt(iso[3]));
  // DD/MM/YY or DD/MM/YYYY
  var dmy = parseDMY(str);
  if (dmy) return dmy;
  // Fallback
  return new Date(str);
}

/** Returns the Monday of the week containing date d. */
function getWeekStart(d) {
  var day = d.getDay() || 7;        // Sunday → 7
  var mon = new Date(d);
  mon.setDate(d.getDate() - (day - 1));
  mon.setHours(0, 0, 0, 0);
  return mon;
}

/** Converts a Date to "YYYY-MM-DD" key string. */
function toKey(d) {
  if (!d || isNaN(d.getTime())) return null;
  return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate());
}


// ══════════════════════════════════════════════════════════════════
// MISC HELPERS
// ══════════════════════════════════════════════════════════════════

function trim(v)      { return (v || '').toString().trim(); }
function pad(n)       { return String(n).padStart(2, '0'); }
function toNumber(v)  { return parseFloat(v) || 0; }
function fmtNum(n)    { return Number(n).toLocaleString('en-KE'); }

function eatNow() {
  return Utilities.formatDate(new Date(), 'Africa/Nairobi', 'yyyy-MM-dd HH:mm:ss');
}

function respond(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function aliasesFromData(data) {
  if (data && data.credits && data.credits.length) {
    return data.credits.map(function (c) { return c.alias; }).join(', ');
  }
  return (data && data.from) || '';
}


// ══════════════════════════════════════════════════════════════════
// TEST & DIAGNOSTIC FUNCTIONS
// ══════════════════════════════════════════════════════════════════

/**
 * diagnoseMasterRecord()
 * Run this first to verify the script reads your sheet correctly.
 * Check the Logger output for alias map and week map entries.
 */
function diagnoseMasterRecord() {
  var ss    = SpreadsheetApp.openById(WORKBOOK_ID);
  var sheet = ss.getSheetByName(MASTER_SHEET);
  if (!sheet) { Logger.log('ERROR: Sheet "' + MASTER_SHEET + '" not found'); return; }

  Logger.log('Sheet: ' + sheet.getName());
  Logger.log('Last row: ' + sheet.getLastRow() + ' | Last col: ' + sheet.getLastColumn());

  // Show date headers from row 6, col G onwards
  Logger.log('=== DATE HEADERS (row ' + DATE_HDR_ROW + ', col ' + FIRST_WEEK_COL + '+) ===');
  var lastCol  = sheet.getLastColumn();
  var weekCols = lastCol - FIRST_WEEK_COL + 1;
  var headers  = sheet.getRange(DATE_HDR_ROW, FIRST_WEEK_COL, 1, weekCols).getValues()[0];
  headers.forEach(function (cell, i) {
    var raw     = trim(cell.toString());
    var first   = raw.split(/[\n\r\s]+/)[0];
    var parsed  = parseDMY(first);
    var key     = toKey(parsed);
    Logger.log('Col ' + colLetter(FIRST_WEEK_COL + i) + ': raw="' + raw.replace(/\n/g,'↵') +
               '" | first="' + first + '" | key=' + key);
  });

  // Show aliases
  Logger.log('=== ALIASES (col E, rows ' + FIRST_DATA_ROW + '–' + LAST_DATA_ROW + ') ===');
  var aliases = sheet.getRange(FIRST_DATA_ROW, ALIAS_COL, LAST_DATA_ROW - FIRST_DATA_ROW + 1, 1).getValues();
  aliases.forEach(function (row, i) {
    var alias = trim(row[0]);
    if (alias) Logger.log('Row ' + (FIRST_DATA_ROW + i) + ': "' + alias + '"');
  });

  // Show what week today's date maps to
  var today    = new Date();
  var weekStart = getWeekStart(today);
  Logger.log('=== TODAY ===');
  Logger.log('Today: ' + toKey(today) + ' → week start: ' + toKey(weekStart));
}

/**
 * testFullPipeline()
 * Simulates a complete deposit submission.
 * Change the date to one that falls within a week column in your sheet.
 * Check: Deposit Log, Master Record cell, Audit Log.
 */
function testFullPipeline() {
  var mockData = {
    pin:         SERVER_PIN,
    clientToken: 'test-runner',
    device:      'Apps Script test',
    date:        '2026-02-17',   // ← Tuesday of week starting 16/02/26
    week:        'W8',
    from:        'Tokyo',
    method:      'MPESA',
    totalAmount: 4000,
    refCode:     'TEST' + new Date().getTime().toString().slice(-6),
    notes:       'Test entry — safe to delete',
    isSplit:     false,
    credits:     [{ alias: 'Tokyo', amount: 4000 }]
  };

  Logger.log('Submitting test deposit for date ' + mockData.date);
  var mock   = { postData: { contents: JSON.stringify(mockData) } };
  var result = JSON.parse(doPost(mock).getContent());
  Logger.log('Result: ' + JSON.stringify(result));
  Logger.log('Workbook: https://docs.google.com/spreadsheets/d/' + WORKBOOK_ID);
}

/**
 * testSplitDeposit()
 * Tests a split deposit across two members.
 */
function testSplitDeposit() {
  var mockData = {
    pin:         SERVER_PIN,
    clientToken: 'test-runner',
    device:      'Apps Script test',
    date:        '2026-02-17',
    week:        'W8',
    from:        'California',
    method:      'MPESA',
    totalAmount: 8000,
    refCode:     'SPLIT' + new Date().getTime().toString().slice(-6),
    notes:       'Split test — safe to delete',
    isSplit:     true,
    credits:     [
      { alias: 'California', amount: 4000 },
      { alias: 'Lisbon',     amount: 4000 }
    ]
  };

  Logger.log('Submitting split test deposit');
  var mock   = { postData: { contents: JSON.stringify(mockData) } };
  var result = JSON.parse(doPost(mock).getContent());
  Logger.log('Result: ' + JSON.stringify(result));
}

/**
 * testWrongPin()
 * Confirms bad PINs are rejected and logged correctly.
 */
function testWrongPin() {
  var mockData = {
    pin:         '0000',
    clientToken: 'attacker-test',
    device:      'Test attacker device',
    from:        'Unknown',
    totalAmount: 999,
    refCode:     'HACK000001',
    credits:     []
  };
  var mock   = { postData: { contents: JSON.stringify(mockData) } };
  var result = JSON.parse(doPost(mock).getContent());
  Logger.log('Expected wrong_pin, got: ' + JSON.stringify(result));
}

/**
 * clearAllLockouts()
 * Removes all rate-limit locks. Use if locked out during testing.
 */
function clearAllLockouts() {
  var props = PropertiesService.getScriptProperties().getProperties();
  Object.keys(props).forEach(function (k) {
    if (k.indexOf('fails_') === 0 || k.indexOf('locked_') === 0) {
      PropertiesService.getScriptProperties().deleteProperty(k);
      Logger.log('Cleared: ' + k);
    }
  });
  Logger.log('All lockouts cleared.');
}

/**
 * viewAuditLog()
 * Prints last 20 audit entries to Logger.
 */
function viewAuditLog() {
  var sheet = SpreadsheetApp.openById(WORKBOOK_ID).getSheetByName(AUDIT_LOG_SHEET);
  if (!sheet) { Logger.log('No Audit Log yet'); return; }
  var rows = sheet.getDataRange().getValues();
  rows.slice(-20).forEach(function (r) { Logger.log(r.join(' | ')); });
}

/** Converts column number to letter(s): 1→A, 7→G, 26→Z, 27→AA */
function colLetter(n) {
  var s = '';
  while (n > 0) {
    s = String.fromCharCode(65 + (n - 1) % 26) + s;
    n = Math.floor((n - 1) / 26);
  }
  return s;
}
